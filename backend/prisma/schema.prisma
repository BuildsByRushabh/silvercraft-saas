// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id            String   @id @default(uuid())
  name          String
  subdomain     String   @unique
  logoUrl       String?  @map("logo_url")
  accentColor   String   @default("#C0B8A7") @map("accent_color")
  theme         String   @default("light")
  plan          String   @default("free")
  customDomain  String?  @map("custom_domain")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  users                User[]
  catalogueItems       CatalogueItem[]
  orders               Order[]
  aiDesignSuggestions  AIDesignSuggestion[]
  auditLogs            AuditLog[]
  apiKeys              ApiKey[]

  @@map("tenants")
}

model User {
  id             String    @id @default(uuid())
  tenantId       String    @map("tenant_id")
  email          String
  name           String
  hashedPassword String    @map("hashed_password")
  role           String
  isActive       Boolean   @default(true) @map("is_active")
  lastLogin      DateTime? @map("last_login")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  tenant                Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders                Order[]
  aiDesignSuggestions   AIDesignSuggestion[]
  auditLogs             AuditLog[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model CatalogueItem {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  name          String
  description   String?
  metalType     String   @map("metal_type")
  stoneType     String?  @map("stone_type")
  price         Decimal? @db.Decimal(10, 2)
  imageUrl      String?  @map("image_url")
  isReadyStock  Boolean  @default(false) @map("is_ready_stock")
  isCustomOnly  Boolean  @default(false) @map("is_custom_only")
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([tenantId])
  @@index([metalType, stoneType])
  @@map("catalogue_items")
}

model Order {
  id                String   @id @default(uuid())
  tenantId          String   @map("tenant_id")
  userId            String?  @map("user_id")
  catalogueItemId   String?  @map("catalogue_item_id")
  orderNumber       String   @unique @map("order_number")
  customerName      String   @map("customer_name")
  customerEmail     String?  @map("customer_email")
  customerPhone     String?  @map("customer_phone")
  status            String   @default("lead")
  customParameters  Json     @default("{}") @map("custom_parameters")
  value             Decimal? @db.Decimal(10, 2)
  notes             String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user           User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  catalogueItem  CatalogueItem? @relation(fields: [catalogueItemId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("orders")
}

model AIDesignSuggestion {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  userId      String?  @map("user_id")
  promptHash  String   @map("prompt_hash")
  parameters  Json
  suggestions Json
  createdAt   DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([tenantId, promptHash])
  @@map("ai_design_suggestions")
}

model AuditLog {
  id           String    @id @default(uuid())
  tenantId     String?   @map("tenant_id")
  userId       String?   @map("user_id")
  action       String
  resourceType String    @map("resource_type")
  resourceId   String?   @map("resource_id")
  changes      Json?
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  createdAt    DateTime  @default(now()) @map("created_at")

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

model ApiKey {
  id          String    @id @default(uuid())
  tenantId    String    @map("tenant_id")
  name        String
  keyHash     String    @unique @map("key_hash")
  permissions Json      @default("[]")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}
